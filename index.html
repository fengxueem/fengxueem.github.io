<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>COVID-19</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
    <!-- add echarts -->
    <script src="echarts.min.js"></script>
    <script src="index.js"></script>
</head>
<body>
    <script type="text/javascript">
        // must manually set up start date for each country, recorde daily change
        var country_list = {
            'cn' : {
                'start_date' : new Date(2020, 0, 20),
                'name' : '中国湖北省外(不含港澳台)',
                'source' : 'http://www.nhc.gov.cn/yjb/pqt/new_list.shtml',
                'daily_diag' : [
                    5, 44, 62, 154, 264, 365, 398,
                    480, 619, 705, 762, 755, 669, 726,
                    896, 731, 707, 696, 558, 509, 444,
                    381, 377, 312, 267, 221, 166, 115,
                    79, 56, 45, 258, 31, 18, 11,
                    9, 5, 24, 9, 4, 3, 6,
                    11, 4, 5, 17, 25, 3, 4, 
                    2, 11, 7, 3, 7, 16, 12,
                    20, 12, 34
                ],
                'daily_death' : [
                    null, 0, 0, 0, 1, 2, 0,
                    2, 1, 1, 1, 1, 0, 1,
                    0, 0, 3, 4, 5, 8, 6,
                    5, 3, 12, 5, 4, 3, 5,
                    5, 4, 6, 3, 3, 1, 1,
                    3, 0, 3, 3, 2, 1, 0,
                    0, 1, 0, 1, 0, 0, 1,
                    0, 0, 1, 1, 0, 0, 0,
                    1, 0, 0
                ]
            }, 
            'de' : {
                'start_date' : new Date(2020, 1, 25),
                'name' : '德国',
                'source' : 'https://interaktiv.morgenpost.de/corona-virus-karte-infektionen-deutschland-weltweit/',
                'daily_diag' : [
                    2, 3, 5, 27, 13, 51, 33,
                    38, 52, 109, 185, 150, 163, 265,
                    453, 401, 779, 930, 910, 1228, 1459,
                    2088, 2967

                ],
                'daily_death' : [
                    0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 2,
                    0, 1, 3, 2, 1, 4, 4,
                    9, 2
                ]
            }, 
        };
        var echart_list = [];
        // define base options for echarts here
        var covidOptionBase = {
            title: {
                text: '每日新增确诊，新增病死',
                subtext: '数据源：'
            },
            tooltip: {},
            legend: {
                data:['新增确诊', '新增病死']
            },
            xAxis: {
                data:[] 
            },
            yAxis: {},
            dataZoom: [
                // x axis data slider
                {   
                    type: 'slider',
                    start: 60,
                    end: 100
                },
                // x axis data inside slider
                {   
                    type: 'inside', 
                    start: 60,     
                    end: 100
                }
            ],
            series: [
                {
                    name: '新增确诊',
                    type: 'line',
                },
                {
                    name: '新增病死',
                    type: 'bar',
                }
            ]
        };
        var benfordOptionBase = {
            timeline: {
                axisType: 'time',
                loop: true,
                autoPlay: true,
                playInterval: 800,
                left: 'left',
                right: 0,
                symbolSize: 4,
                label:{
                    show: false
                }
            },
            title: {
                text: '止每日新增确诊本福特验证'
            },
            tooltip: {},
            legend: {
                data:['本福特值', '实际结果']
            },
            xAxis: {
                data: [
                    "1","2","3","4","5","6","7",
                    "8","9"
                ]
            },
            yAxis: {},
            series: [
                {
                    name: '本福特值',
                    type: 'line',
                    data: [
                        0.301, 0.176, 0.125, 0.097, 0.079, 0.067, 0.058,
                        0.051, 0.046
                    ]
                },
                {
                    name: '实际结果',
                    type: 'bar',
                }
            ]
        };
        // get current window height
        chartHeight = 0.8 * getWindowHeight();
        // setup echarts
        for(var key in country_list) {
            // create div element
            var createCovidDailyDiv = document.createElement("div");  
            var createBenfordLawDiv = document.createElement("div");  
            createCovidDailyDiv.style.width = "100%";  
            createCovidDailyDiv.style.height = chartHeight +"px";  
            createCovidDailyDiv.id = key + '_covid_daily';  
            createBenfordLawDiv.style.width = "100%";  
            createBenfordLawDiv.style.height = chartHeight +"px";  
            createBenfordLawDiv.id = key + '_benford_law';
            // append divs to the end of the html body
            document.body.appendChild(createCovidDailyDiv);  
            document.body.appendChild(createBenfordLawDiv);
            // create echart
            var covidDaily = echarts.init(createCovidDailyDiv);
            var benfordLaw = echarts.init(createBenfordLawDiv);
            var today = new Date();
            var date_list = getDiffDate(country_list[key].start_date, new Date(today.getTime() - 24*60*60*1000));
            // set up options of covid
            var covidOption = copy_obj(covidOptionBase);
            covidOption.title.text = country_list[key].name + covidOption.title.text;
            covidOption.title.subtext = covidOption.title.subtext + country_list[key].source;
            covidOption.xAxis.data = date_list;
            covidOption.series[0].data = country_list[key].daily_diag;
            covidOption.series[1].data = country_list[key].daily_death;
            // set up options of benford
            benfordOptionBase.timeline.data = date_list;
            var benfordOptions = [];
            for (var index = 0; index < date_list.length; index++) {
                var this_day_diag = copy_obj(country_list[key].daily_diag);
                this_day_diag = this_day_diag.splice(0, index + 1);
                var this_option = {
                    title: {
                        text: country_list[key].name + date_list[index] + benfordOptionBase.title.text
                    },
                    series: [
                        {data: benfordOptionBase.series[0].data},
                        {data: histBenford(this_day_diag)}
                    ]
                };
                benfordOptions.push(this_option);
            }
            // bind data with echarts
            covidDaily.setOption(covidOption);
            benfordLaw.setOption(
                {
                    baseOption: benfordOptionBase,
                    options: benfordOptions
                }
            );
            // add echarts to global list for future modification
            echart_list.push(covidDaily);
            echart_list.push(benfordLaw);
        }
        // make sure echarts have proper shape after resizing the window
        window.addEventListener("resize",function(){
            chartHeight = 0.8 * getWindowHeight();
            for(var key in country_list) {
                document.getElementById(key + "_covid_daily").style.height = chartHeight +"px";
                document.getElementById(key + "_benford_law").style.height = chartHeight +"px";
            }
            for(var key in echart_list) {
                echart_list[key].resize();
            }
        });
    </script>
</body>
</html>