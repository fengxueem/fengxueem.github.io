<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>COVID-19</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <!-- add echarts -->
    <script src="js/echarts.min.js"></script>
    <script src="js/index.js"></script>
    <!-- add bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/5f9d5ec290.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm bg-light navbar-light">
            <ul class="navbar-nav">
              <li class="nav-item active">
                <a class="nav-link" href="#">
                  <i class="fas fa-virus"></i>
                </a>
              </li>
              <li class="nav-item active">
                <a class="nav-link" href="html/test.html">关于我</a>
              </li>
              <!-- Dropdown -->
              <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">小学数学</a>
                  <div class="dropdown-menu">
                      <a class="dropdown-item" href="html/pick_a_ball.html">Pick A Ball</a>
                      <a class="dropdown-item" href="html/schulte_grid.html">Schulte Grid</a>
                  </div>
              </li>
            </ul>
        </nav>
    </header>
    <script type="text/javascript">
        // must manually set up start date for each country, recorde daily change
        var country_list = {
            'cn' : {
                'start_date' : new Date(2020, 0, 20),
                'name' : '中国大陆地区湖北省外',
                'source' : 'http://www.nhc.gov.cn/yjb/pqt/new_list.shtml, http://wjw.hubei.gov.cn/fbjd/tzgg/',
                'daily_diag' : [
                    5,      44,     62,     154,    264,    365,    398,
                    480,    619,    705,    762,    755,    669,    726,
                    896,    731,    707,    696,    558,    509,    444,
                    381,    377,    312,    267,    221,    166,    115,
                    79,     56,     45,     258,    31,     18,     11,
                    9,      5,      24,     9,      4,      3,      6,
                    11,     4,      5,      17,     25,     3,      4, 
                    2,      11,     7,      3,      7,      16,     12,
                    20,     12,     34,     39,     41,     46,     39,
                    77,     47,     67,     55,     54,     45,     31,
                    48,     34,     35,     31,     18,     30,     39,
                    32,     62,     63,     42,     46,     99,     108,
                    89,     46,     46,     26,     27,     16,     12,
                    11,     30,     10,     6,      12,     11,     3,
                    6,      22,     4,      12,     1,      2,      3,
                    1,      2,      2,      1,      1,      13,     12,
                    1,      7,      3,      4,      8,      5,      7,
                    5,      5,      2,      4,      0,      3,      11,
                    7,      1,      2,      0,      4,      2,      16,
                    5,      1,      1,      5,      3,      6,      4,
                    3,      3,      11,     6,      11,     57,     49,
                    40,     44,     28,     32,     27,     26,     18,
                    22,     12,     19,     13,     21,     17,     12,
                    19,     3,      3,      5,      3,      8,      4,
                    8,      7,      9,      4,      2,      7,      8,
                    3,      6,      1,      10,     22,     16,     22,
                    11,     14,     22,     21,     34,     46,     61,
                    68,     101,    105,    127,    45,     46,     43,
                    36,     27,     37,     37,     31,     23,     49,
                    44,     25,     19,     30,     22,     19,     22,
                    22,     17,     7,      22,     22,     12,     16,
                    14,     15,     8,      9,      9,      9,      17,
                    10,     8,      11,     25,     10,     10,     12,
                    10,     2,      7,      15,     6,      10,     10,
                    8,      12,     9,      32,     14,     10,     12,
                    6,      10,     7,      8,      15,     14,     21,
                    12,     19,     11,     10,     10,     16,     20,
                    12,     7,      11,     21,     15,     21,     21,
                    13,     20,     11,     24,     13,     13,     13,
                    19,     11,     14,     18,     28,     15 ,    20,
                    16,     42,     47,     25,     33,     24,     24,
                    45,     17,     28,     36,     33,     24,     33,
                    22,     17,     15,     8,      18,     12
                ],
                'daily_death' : [
                    null,   0,      0,      0,      1,      2,      0,
                    2,      1,      1,      1,      1,      0,      1,
                    0,      0,      3,      4,      5,      8,      6,
                    5,      3,      12,     5,      4,      3,      5,
                    5,      4,      6,      3,      3,      1,      1,
                    3,      0,      3,      3,      2,      1,      0,
                    0,      1,      0,      1,      0,      0,      1,
                    0,      0,      1,      1,      0,      0,      0,
                    1,      0,      0,      1,      0,      1,      0,
                    0,      1,      0,      0,      0,      0,      0,
                    0,      1,      0,      0,      0,      0,      0,
                    0,      1,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0
                ],
                'daily_asym' : [
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   83,     18,     9,      26,     24,     43,
                    12,     107,    32,     29,     17,     43,     44,
                    32,     25,     27,     34,     21,     22,     25,
                    17,     14,     6,      12,     9,      11,     7,
                    13,     9,      7,      6,      2,      3,      4,
                    3,      4,      0,      0,      2,      3,      1,
                    4,      2,      1,      2,      3,      2,      4,
                    1,      1,      3,      0,      3,      6,      2,
                    3,      6,      4,      3,      1,      2,      16,
                    10,     3,      4,      3,      2,      5,      2,
                    21,     5,      4,      1,      7,      7,      18,
                    6,      11,     8,      5,      7,      5,      7,
                    7,      3,      1,      5,      12,     7,      6,
                    4,      3,      2,      4,      1,      7,      11,
                    15,     5,      6,      3,      4,      5,      6,
                    5,      4,      2,      5,      14,     42,     13,
                    6,      22,     31,     43,     74,     68,     44,
                    34,     27,     21,     11,     23,     19,     11,
                    21,     24,     20,     14,     14,     11,     31,
                    17,     20,     20,     28,     20,     16,     37,
                    17,     14,     22,     23,     34,     15,     27,
                    16,     14,     19,     16,     10,     4,      19,
                    34,     19,     12,     26,     8,      17,     17,
                    13,     8,      15,     22,     8,      70,     39,
                    9,      16,     14,     20,     24,     21,     25,
                    15,     18,     20,     18,     30,     26,     14,
                    26,     22,     10,     33,     12,     26,     23,
                    31,     24,     8,      15,     39,     23,     32,
                    17,     18,     23,     10,     11,     34,     33,
                    24,     15,     25,     11,     27,     19,     161,
                    50,     38,     16,     53,     38,     69,     30,
                    42,     128,    21,     33,     27,     34,     9,
                    25,     15,     5,      15,     10,     6
                ]
            }, 
            'de' : {
                'start_date' : new Date(2020, 1, 25),
                'name' : '德国',
                'source' : 'https://interaktiv.morgenpost.de/corona-virus-karte-infektionen-deutschland-weltweit/',
                'daily_diag' : [
                    2,      3,      5,      29,     13,     51,     33,
                    38,     74,     138,    239,    156,    103,    246,
                    421,    401,    779,    930,    910,    1228,   1459,
                    2088,   2967,   2993,   4717,   2440,   3001,   4073,
                    4042,   4020,   6804,   6051,   4962,   4173,   3694,
                    5176,   6174,   6333,   5882,   5788,   4214,   3281,
                    4263,   5009,   4938,   4364,   3395,   2618,   2420,
                    2162,   2853,   3021,   3247,   2521,   1777,   1337,
                    1904,   2367,   2425,   1609,   1861,   1549,   846,
                    1370,   1488,   1542,   1267,   784,    658,    631,
                    921,    1175,   1178,   1194,   891,    467,    544,
                    774,    923,    897,    635,    648,    389,    443,
                    755,    681,    614,    517,    503,    254,    402,
                    458,    664,    547,    573,    298,    282,    277,
                    265,    358,    467,    347,    314,    182,    326,
                    324,    489,    360,    308,    252,    196,    357,
                    343,    603,    1037,   391,    621,    558,    464,
                    584,    661,    475,    677,    313,    258,    480,
                    455,    508,    427,    431,    273,    219,    379,
                    387,    433,    438,    339,    261,    160,    407,
                    344,    543,    583,    512,    224,    252,    513,
                    443,    641,    742,    780,    317,    325,    650,
                    682,    889,    872,    997,    220,    531,    822,
                    745,    1047,   1165,   1104,   574,    437,    957,
                    1216,   1440,   1569,   1283,   656,    564,    1386,
                    1504,   1703,   1435,   2028,   823,    690,    1266,
                    1580,   1489,   1572,   1472,   808,    617,    1205,
                    1243,   1315,   1446,   1357,   1020,   839,    1464,
                    1246,   1826,   1478,   1633,   961,    932,    1545,
                    1744,   2183,   1979,   2304,   1347,   926,    1788,
                    1775,   2128,   2133,   2544,   1668,   1031,   1994,
                    1859,   2500,   2682,   2742,   2134,   1406,   2565,
                    2836,   4058,   4500,   4818,   3430,   2701,   3965,
                    4996,   6674,   7388,   8092,   5324,   4382,   6832,
                    7691,   11265,  11473,  14579,  11136,  8887,   11608,
                    14798,  16824,  18745,  19354,  13971,  12020,  15157,
                    17763,  19839,  21591,  23279,  16271,  13565,  15192,
                    18360,  21931,  23556,  22504,  16785
                ],
                'daily_death' : [
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    2,      1,      3,      2,      1,      4,      3,
                    9,      2,      16,     25,     15,     15,     30,
                    35,     42,     65,     73,     76,     57,     139,
                    135,    158,    198,    168,    152,    149,    104,
                    303,    213,    255,    237,    48,     260,    62,
                    280,    311,    294,    260,    248,    135,    120,
                    327,    217,    122,    351,    123,    98,     106,
                    165,    184,    173,    136,    86,     54,     87,
                    90,     250,    117,    76,     81,     11,     93,
                    69,     137,    25,     29,     33,     29,     65,
                    71,     58,     43,     29,     33,     13,     36,
                    65,     60,     35,     36,     20,     7,      10,
                    20,     33,     33,     23,     19,     5,      37,
                    22,     19,     8,      15,     9,      5,      10,
                    25,     28,     15,     13,     0,      2,      7,
                    19,     12,     19,     13,     1,      4,      9,
                    12,     7,      10,     6,      6,      2,      4,
                    12,     14,     7,      7,      3,      1,      5,
                    2,      6,      5,      0,      1,      2,      3,
                    6,      5,      10,     6,      1,      0,      3,
                    6,      5,      8,      7,      1,      0,      7,
                    12,     7,      8,      12,     2,      1,      4,
                    6,      4,      13,     5,      0,      1,      4,
                    7,      9,      9,      7,      1,      3,      5,
                    3,      6,      2,      1,      7,      3,      4,
                    11,     8,      0,      3,      1,      0,      4,
                    8,      3,      0,      7,      2,      1,      11,
                    6,      3,      7,      5,      3,      0,      9,
                    14,     19,     14,     9,      8,      2,      11,
                    16,     13,     8,      18,     3,      4,      16,
                    12,     16,     12,     15,     11,     6,      14,
                    42,     34,     23,     34,     12,     13,     44,
                    40,     29,     49,     48,     27,     27,     41,
                    86,     92,     78,     103,    42,     37,     128,
                    159,    121,    161,    130,    66,     66,     152,
                    257,    213,    222,    188,    107
                ]
            }, 
        };
        var echart_list = [];
        // define base options for echarts here
        var covidOptionBase = {
            title: {
                text: '每日新增确诊，新增病死',
                subtext: '数据源：'
            },
            tooltip: {},
            legend: {
                orient: 'vertical',
                top: '10%',
                right: '1%',
                textStyle: {
                    fontSize: '14',
                },
                data:['新增确诊', '新增病死']
            },
            xAxis: {
                data:[],
                splitArea: {
                    // split background by 7 days a group
                    interval: 6,
                    show: true,
                },
            },
            yAxis: {},
            dataZoom: [
                // x axis data slider
                {   
                    type: 'slider',
                    start: 60,
                    end: 100
                },
                // x axis data inside slider
                {   
                    type: 'inside', 
                    start: 60,     
                    end: 100
                }
            ],
            series: [
                {
                    name: '新增确诊',
                    type: 'line',
                },
                {
                    name: '新增病死',
                    type: 'bar',
                },
            ]
        };
        var benfordOptionBase = {
            timeline: {
                axisType: 'time',
                loop: true,
                autoPlay: true,
                playInterval: 800,
                left: 'left',
                right: 0,
                symbolSize: 4,
                label:{
                    show: false
                }
            },
            title: {
                text: '止每日新增确诊本福特验证'
            },
            tooltip: {},
            legend: {
                data:['本福特值', '实际结果']
            },
            xAxis: {
                data: [
                    "1","2","3","4","5","6","7",
                    "8","9"
                ]
            },
            yAxis: {},
            series: [
                {
                    name: '本福特值',
                    type: 'line',
                    data: [
                        0.301, 0.176, 0.125, 0.097, 0.079, 0.067, 0.058,
                        0.051, 0.046
                    ]
                },
                {
                    name: '实际结果',
                    type: 'bar',
                }
            ]
        };
        // get current window height
        chartHeight = 0.8 * getWindowHeight();
        // setup echarts
        for(var key in country_list) {
            // create div element
            var createCovidDailyDiv = document.createElement("div");  
            var createBenfordLawDiv = document.createElement("div");  
            createCovidDailyDiv.style.width = "100%";  
            createCovidDailyDiv.style.height = chartHeight +"px";  
            createCovidDailyDiv.id = key + '_covid_daily';  
            createBenfordLawDiv.style.width = "100%";  
            createBenfordLawDiv.style.height = chartHeight +"px";  
            createBenfordLawDiv.id = key + '_benford_law';
            // append divs to the end of the html body
            document.body.appendChild(createCovidDailyDiv);  
            document.body.appendChild(createBenfordLawDiv);
            // create echart
            var covidDaily = echarts.init(createCovidDailyDiv);
            var benfordLaw = echarts.init(createBenfordLawDiv);
            var today = new Date();
            var date_list = getDiffDate(country_list[key].start_date, new Date(today.getTime() - 24*60*60*1000));
            // set up options of covid
            var covidOption = copy_obj(covidOptionBase);
            covidOption.title.text = country_list[key].name + covidOption.title.text;
            covidOption.title.subtext = covidOption.title.subtext + country_list[key].source;
            covidOption.series[0].data = country_list[key].daily_diag;
            covidOption.series[1].data = country_list[key].daily_death;
            // add an echart for china's asym vs confirmed
            if (key == 'cn') {
                covidOption.title.text += '，新增无症状';
                covidOption.legend.data.push('新增无症状');
                covidOption.series.push(
                    {
                        name : '新增无症状',
                        type : 'line',
                        data : country_list['cn'].daily_asym
                    });
            }
            // Provide daily new cases prediction if no newest data is given
            // Do NOT predict new death, since I deeply hope that every patient will be fully recovered!
            // At least show prediction for 2 days: the last valid day and the next day
            // For example:
            // +------------+---------------+----------------+--------------+--------------+
            // |    today   |  valid days   | last valid day | missing days |   next day   |
            // +------------+---------------+----------------+--------------+--------------+
            // | 2020-04-11 | .. 2020-04-10 |   2020-04-10   |     null     |  2020-04-11  |
            // +------------+---------------+----------------+--------------+--------------+
            // | 2020-04-11 | .. 2020-04-09 |   2020-04-09   |  2020-04-10  |  2020-04-11  |
            // +------------+---------------+----------------+--------------+--------------+
            var least_pred_day = 2;
            var num_valid = country_list[key].daily_diag.length;
            var num_missing = date_list.length - num_valid;
            var num_pred = least_pred_day + num_missing;
            var preds = new Array(num_pred);
            preds.forEach(element => {
                element = null;
            });
            // rea-world data before the prediction
            var before_predict = new Array(num_valid - 1);
            before_predict.forEach(element => {
                element = null;
            });
            before_predict[num_valid - 2] = country_list[key].daily_diag[num_valid - 2];
            // prediction for the last valid day
            predict_type = 1;
            preds[0] = predict(country_list[key].daily_diag.slice(0, num_valid - 1), predict_type);
            // predict for the missing days and the next day
            for (let index = 0; index < num_missing + 1; index++) {
                preds[1 + index] = predict(country_list[key].daily_diag.concat(preds.slice(Math.max(index, 1), preds.length)), predict_type);
            }
            covidOption.title.text += ', 预测新增确诊';
            covidOption.legend.data.push('预测新增确诊');
            covidOption.series.push(
                {
                    name : '预测新增确诊',
                    type : 'line',
                    lineStyle: {
                        color: 'red',
                        type: 'dashed'
                    },
                    itemStyle: {
                        borderColor: 'red',
                        color: 'red'
                    },
                    // connect the prediction with read-world data
                    data: before_predict.concat(preds)
                }
            );
            // add the next day on x axis
            var tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            covidOption.xAxis.data = date_list.concat(getDiffDate(today, tomorrow));
            // set up options of benford
            benfordOptionBase.timeline.data = date_list;
            var benfordOptions = [];
            for (var index = 0; index < date_list.length; index++) {
                var this_day_diag = copy_obj(country_list[key].daily_diag);
                this_day_diag = this_day_diag.splice(0, index + 1);
                var this_option = {
                    title: {
                        text: country_list[key].name + date_list[index] + benfordOptionBase.title.text
                    },
                    series: [
                        {data: benfordOptionBase.series[0].data},
                        {data: histBenford(this_day_diag)}
                    ]
                };
                benfordOptions.push(this_option);
            }
            // bind data with echarts
            covidDaily.setOption(covidOption);
            benfordLaw.setOption(
                {
                    baseOption: benfordOptionBase,
                    options: benfordOptions
                }
            );
            // add echarts to global list for future modification
            echart_list.push(covidDaily);
            echart_list.push(benfordLaw);
        }
        // make sure echarts have proper shape after resizing the window
        window.addEventListener("resize",function(){
            chartHeight = 0.8 * getWindowHeight();
            for(var key in country_list) {
                document.getElementById(key + "_covid_daily").style.height = chartHeight +"px";
                document.getElementById(key + "_benford_law").style.height = chartHeight +"px";
            }
            for(var key in echart_list) {
                echart_list[key].resize();
            }
        });
    </script>
</body>
</html>