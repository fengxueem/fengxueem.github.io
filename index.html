<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>COVID-19</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
    <!-- add echarts -->
    <script src="echarts.min.js"></script>
    <script src="index.js"></script>
</head>
<body>
    <script type="text/javascript">
        // must manually set up start date for each country, recorde daily change
        var country_list = {
            'cn' : {
                'start_date' : new Date(2020, 0, 20),
                'name' : '中国大陆地区湖北省外',
                'source' : 'http://www.nhc.gov.cn/yjb/pqt/new_list.shtml, http://wjw.hubei.gov.cn/fbjd/tzgg/',
                'daily_diag' : [
                    5,      44,     62,     154,    264,    365,    398,
                    480,    619,    705,    762,    755,    669,    726,
                    896,    731,    707,    696,    558,    509,    444,
                    381,    377,    312,    267,    221,    166,    115,
                    79,     56,     45,     258,    31,     18,     11,
                    9,      5,      24,     9,      4,      3,      6,
                    11,     4,      5,      17,     25,     3,      4, 
                    2,      11,     7,      3,      7,      16,     12,
                    20,     12,     34,     39,     41,     46,     39,
                    77,     47,     67,     55,     54,     45,     31,
                    48,     34,     35,     31,     18,     30,     39,
                    32,     62,     63,     42,     46,     99,     108,
                    89,     46,     46,     26,     27,     16,     12,
                    11,     30,     10,     6,      12,     11,     3,
                    6,      22,     4,      12,     1,      2,      3,
                    1,      2,      2,      1,      1,      13,     12,
                    1,      7,      3,      4,      8,      5,      7,
                    5,      5,      2,      4,      0,      3,      11,
                    7,      1,      2,      0,      4,      2,      16,
                    5,      1,      1,      5,      3,      6,      4,
                    3,      3,      11,     6,      11,     57,     49,
                    40,     44,     28
                ],
                'daily_death' : [
                    null,   0,      0,      0,      1,      2,      0,
                    2,      1,      1,      1,      1,      0,      1,
                    0,      0,      3,      4,      5,      8,      6,
                    5,      3,      12,     5,      4,      3,      5,
                    5,      4,      6,      3,      3,      1,      1,
                    3,      0,      3,      3,      2,      1,      0,
                    0,      1,      0,      1,      0,      0,      1,
                    0,      0,      1,      1,      0,      0,      0,
                    1,      0,      0,      1,      0,      1,      0,
                    0,      1,      0,      0,      0,      0,      0,
                    0,      1,      0,      0,      0,      0,      0,
                    0,      1,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0
                ],
                'daily_asym' : [
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   null,   null,   null,   null,   null,   null,
                    null,   83,     18,     9,      26,     24,     43,
                    12,     107,    32,     29,     17,     43,     44,
                    32,     25,     27,     34,     21,     22,     25,
                    17,     14,     6,      12,     9,      11,     7,
                    13,     9,      7,      6,      2,      3,      4,
                    3,      4,      0,      0,      2,      3,      1,
                    4,      2,      1,      2,      3,      2,      4,
                    1,      1,      3,      0,      3,      6,      2,
                    3,      6,      4,      3,      1,      2,      16,
                    10,     3,      4,      3,      2,      5,      2,
                    21,     5,      4,      1,      7,      7,      18,
                    6,      11,     8
                ]
            }, 
            'de' : {
                'start_date' : new Date(2020, 1, 25),
                'name' : '德国',
                'source' : 'https://interaktiv.morgenpost.de/corona-virus-karte-infektionen-deutschland-weltweit/',
                'daily_diag' : [
                    2,      3,      5,      29,     13,     51,     33,
                    38,     74,     138,    239,    156,    103,    246,
                    421,    401,    779,    930,    910,    1228,   1459,
                    2088,   2967,   2993,   4528,   2516,   2509,   4183,
                    3935,   4622,   5598,   5828,   5229,   4387,   3887,
                    4516,   5858,   6581,   5995,   5807,   4672,   2974,
                    4133,   5095,   4470,   5164,   3518,   2800,   2508,
                    1847,   2973,   3006,   3423,   2566,   1974,   1390,
                    1187,   2597,   2547,   2232,   1861,   1276,   740,
                    1342,   1454,   1448,   1505,   788,    714,    617,
                    756,    1200,   1080,   1237,   1053,   523,    523,
                    721,    945,    873,    752,    576,    474,    401,
                    496,    807,    705,    513,    497,    389,    288,
                    436,    625,    627,    537,    389,    292,    304,
                    226,    320,    445,    443,    262,    261,    217,
                    350,    410,    445,    318,    240,    243,    267,
                    348,    426
                ],
                'daily_death' : [
                    0,      0,      0,      0,      0,      0,      0,
                    0,      0,      0,      0,      0,      0,      0,
                    2,      1,      3,      2,      1,      4,      4,
                    9,      2,      16,     24,     16,     11,     28,
                    36,     47,     56,     61,     75,     58,     109,
                    137,    161,    140,    151,    166,    99,     157,
                    239,    253,    246,    224,    154,    130,    165,
                    233,    334,    288,    263,    199,    114,    124,
                    198,    289,    254,    183,    189,    81,     105,
                    212,    203,    144,    201,    58,     71,     73,
                    141,    161,    103,    144,    83,     9,      66,
                    125,    98,     79,     85,     41,     24,     41,
                    78,     63,     59,     25,     33,     22,     26,
                    63,     56,     42,     34,     26,     10,     15,
                    7,      40,     33,     23,     15,     12,     10,
                    41,     16,     20,     11,     10,     8,      6,
                    13,     31
                ]
            }, 
        };
        var echart_list = [];
        // define base options for echarts here
        var covidOptionBase = {
            title: {
                text: '每日新增确诊，新增病死',
                subtext: '数据源：'
            },
            tooltip: {},
            legend: {
                orient: 'vertical',
                top: '10%',
                right: '1%',
                textStyle: {
                    fontSize: '14',
                },
                data:['新增确诊', '新增病死']
            },
            xAxis: {
                data:[],
                splitArea: {
                    // split background by 7 days a group
                    interval: 6,
                    show: true,
                },
            },
            yAxis: {},
            dataZoom: [
                // x axis data slider
                {   
                    type: 'slider',
                    start: 60,
                    end: 100
                },
                // x axis data inside slider
                {   
                    type: 'inside', 
                    start: 60,     
                    end: 100
                }
            ],
            series: [
                {
                    name: '新增确诊',
                    type: 'line',
                },
                {
                    name: '新增病死',
                    type: 'bar',
                },
            ]
        };
        var benfordOptionBase = {
            timeline: {
                axisType: 'time',
                loop: true,
                autoPlay: true,
                playInterval: 800,
                left: 'left',
                right: 0,
                symbolSize: 4,
                label:{
                    show: false
                }
            },
            title: {
                text: '止每日新增确诊本福特验证'
            },
            tooltip: {},
            legend: {
                data:['本福特值', '实际结果']
            },
            xAxis: {
                data: [
                    "1","2","3","4","5","6","7",
                    "8","9"
                ]
            },
            yAxis: {},
            series: [
                {
                    name: '本福特值',
                    type: 'line',
                    data: [
                        0.301, 0.176, 0.125, 0.097, 0.079, 0.067, 0.058,
                        0.051, 0.046
                    ]
                },
                {
                    name: '实际结果',
                    type: 'bar',
                }
            ]
        };
        // get current window height
        chartHeight = 0.8 * getWindowHeight();
        // setup echarts
        for(var key in country_list) {
            // create div element
            var createCovidDailyDiv = document.createElement("div");  
            var createBenfordLawDiv = document.createElement("div");  
            createCovidDailyDiv.style.width = "100%";  
            createCovidDailyDiv.style.height = chartHeight +"px";  
            createCovidDailyDiv.id = key + '_covid_daily';  
            createBenfordLawDiv.style.width = "100%";  
            createBenfordLawDiv.style.height = chartHeight +"px";  
            createBenfordLawDiv.id = key + '_benford_law';
            // append divs to the end of the html body
            document.body.appendChild(createCovidDailyDiv);  
            document.body.appendChild(createBenfordLawDiv);
            // create echart
            var covidDaily = echarts.init(createCovidDailyDiv);
            var benfordLaw = echarts.init(createBenfordLawDiv);
            var today = new Date();
            var date_list = getDiffDate(country_list[key].start_date, new Date(today.getTime() - 24*60*60*1000));
            // set up options of covid
            var covidOption = copy_obj(covidOptionBase);
            covidOption.title.text = country_list[key].name + covidOption.title.text;
            covidOption.title.subtext = covidOption.title.subtext + country_list[key].source;
            covidOption.series[0].data = country_list[key].daily_diag;
            covidOption.series[1].data = country_list[key].daily_death;
            // add an echart for china's asym vs confirmed
            if (key == 'cn') {
                covidOption.title.text += '，新增无症状';
                covidOption.legend.data.push('新增无症状');
                covidOption.series.push(
                    {
                        name : '新增无症状',
                        type : 'line',
                        data : country_list['cn'].daily_asym
                    });
            }
            // Provide daily new cases prediction if no newest data is given
            // Do NOT predict new death, since I deeply hope that every patient will be fully recovered!
            // At least show prediction for 2 days: the last valid day and the next day
            // For example:
            // +------------+---------------+----------------+--------------+--------------+
            // |    today   |  valid days   | last valid day | missing days |   next day   |
            // +------------+---------------+----------------+--------------+--------------+
            // | 2020-04-11 | .. 2020-04-10 |   2020-04-10   |     null     |  2020-04-11  |
            // +------------+---------------+----------------+--------------+--------------+
            // | 2020-04-11 | .. 2020-04-09 |   2020-04-09   |  2020-04-10  |  2020-04-11  |
            // +------------+---------------+----------------+--------------+--------------+
            var least_pred_day = 2;
            var num_valid = country_list[key].daily_diag.length;
            var num_missing = date_list.length - num_valid;
            var num_pred = least_pred_day + num_missing;
            var preds = new Array(num_pred);
            preds.forEach(element => {
                element = null;
            });
            // rea-world data before the prediction
            var before_predict = new Array(num_valid - 1);
            before_predict.forEach(element => {
                element = null;
            });
            before_predict[num_valid - 2] = country_list[key].daily_diag[num_valid - 2];
            // prediction for the last valid day
            predict_type = 1;
            preds[0] = predict(country_list[key].daily_diag.slice(0, num_valid - 1), predict_type);
            // predict for the missing days and the next day
            for (let index = 0; index < num_missing + 1; index++) {
                preds[1 + index] = predict(country_list[key].daily_diag.concat(preds.slice(Math.max(index, 1), preds.length)), predict_type);
            }
            covidOption.title.text += ', 预测新增确诊';
            covidOption.legend.data.push('预测新增确诊');
            covidOption.series.push(
                {
                    name : '预测新增确诊',
                    type : 'line',
                    lineStyle: {
                        color: 'red',
                        type: 'dashed'
                    },
                    itemStyle: {
                        borderColor: 'red',
                        color: 'red'
                    },
                    // connect the prediction with read-world data
                    data: before_predict.concat(preds)
                }
            );
            // add the next day on x axis
            var tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            covidOption.xAxis.data = date_list.concat(getDiffDate(today, tomorrow));
            // set up options of benford
            benfordOptionBase.timeline.data = date_list;
            var benfordOptions = [];
            for (var index = 0; index < date_list.length; index++) {
                var this_day_diag = copy_obj(country_list[key].daily_diag);
                this_day_diag = this_day_diag.splice(0, index + 1);
                var this_option = {
                    title: {
                        text: country_list[key].name + date_list[index] + benfordOptionBase.title.text
                    },
                    series: [
                        {data: benfordOptionBase.series[0].data},
                        {data: histBenford(this_day_diag)}
                    ]
                };
                benfordOptions.push(this_option);
            }
            // bind data with echarts
            covidDaily.setOption(covidOption);
            benfordLaw.setOption(
                {
                    baseOption: benfordOptionBase,
                    options: benfordOptions
                }
            );
            // add echarts to global list for future modification
            echart_list.push(covidDaily);
            echart_list.push(benfordLaw);
        }
        // make sure echarts have proper shape after resizing the window
        window.addEventListener("resize",function(){
            chartHeight = 0.8 * getWindowHeight();
            for(var key in country_list) {
                document.getElementById(key + "_covid_daily").style.height = chartHeight +"px";
                document.getElementById(key + "_benford_law").style.height = chartHeight +"px";
            }
            for(var key in echart_list) {
                echart_list[key].resize();
            }
        });
    </script>
</body>
</html>